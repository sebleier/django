<!DOCTYPE html>
<html>
<head>
  <title>QUnit Test Suite</title>
  <link rel="stylesheet" href="/test/qunit/qunit.css" type="text/css" media="screen">
  <!--<script type="text/javascript" src="/test/qunit/qunit.js"></script>-->
  <script type="text/javascript" src="/test/store+json2.min.js"></script>
  {% block extra_styles %}
  <style type="text/css">
    body { margin: 0px; }
    .hidden { display: none; }
    a { text-decoration: none; outline: none; }
    a:hover { text-decoration: underline; }

    .app { display: inline-block; margin: 2px 2px 5px 2px; padding: 16px 8px; background: #fff; border: 1px solid #ddd; -webkit-border-radius: 6px; -moz-border-radius: 6px; -webkit-box-shadow: 1px 1px 3px #ddd; vertical-align: top; }
    .app h3 { margin: 0; padding: 3px 0; font-size: 14px; line-height: 20px; color: #333; text-align: center; }
    .app h3 a { margin: 0; padding: 3px 0; font-size: 14px; line-height: 20px; color: #333; text-align: center; }
    .app p:last-child { text-align: center; }
    .app p button { margin-top: 5px; color: #616b4c; font-size: 10px; background: #ffff99; border-color: #cccc66; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px;}

    .apps { padding: 10px; }
    .apps p { margin: 0; font-size: 16px; color: #333; }
    .apps p a { display: block; margin: 0 5px; padding: 8px; border: 1px solid #ddd; border-bottom: none; background: #eee; color: #333; }
    .apps p a small { display: block; margin-top: 3px; font-size: 12px; color: #999; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
    .apps p a strong { display: block; margin-bottom: 3px; font-size: 15px; color: #999; }
    .apps p a em { font-weight: bold; font-style: normal; }

    .apps p a { -webkit-border-top-left-radius: 4px; -webkit-border-top-right-radius: 4px; -moz-border-radius-topleft: 4px; -moz-border-radius-topright: 4px; }
    .apps p a { border-bottom: 1px solid #c8de9d; -webkit-border-bottom-left-radius: 4px; -webkit-border-bottom-right-radius: 4px; -moz-border-radius-bottomleft: 4px; -moz-border-radius-bottomright: 4px; }

    .apps p a:hover { background: #175e99 !important; border-color: #175e99 !important; color: #fff !important; text-decoration: none; }
    .apps p a:hover small,
    .apps p a:hover strong { color: #fff !important; }

    .apps p a.passed { background: #eeffcc; border-color: #c8de9d; }
    .apps p a.passed small { color: #616b4c; }
    .apps p a.passed strong { color: #98a978; }

    .apps p a.failed { background: #cc4949; border-color: #ad3e3e; }
    .apps p a.failed small,
    .apps p a.failed strong { color: #fff; }

    #qunit-testrunner-toolbar a {
      border-radius: 5px;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      font: normal 14px "Trebuchet MS", sans-serif;
      padding: 4px 8px 4px 8px;
      text-decoration: none;
      line-height: 30px;
      border: #ccc solid 1px;
      color: #333;
      background-color: #fff;
    }

    #qunit-testrunner-toolbar a:hover {
      color: #fff;
      background-color: #333;
    }
  </style>
  {% endblock %}

  {% block extrahead %}{% endblock extrahead %}
  <!-- TODO: include django's bundled jQuery -->
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script type="text/javascript">

   function get_keys(obj) {
      var keys = [];
      var key;
      for (key in obj) {
          if (obj.hasOwnProperty(key)) {
              keys.push(key);
          }
      }
      return keys;
    }

    var suite_hashes = {
      {% for app, opts in app_suites.apps.items %}
        '{{ app }}': '{{ opts.suite.get_hash }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    }

    var results;
    function initializeResults() {
      results = {
        {% for app in app_suites.apps.keys %}
          '{{ app }}': {}{% if not forloop.last %},{% endif %}
        {% endfor %}
      }
    }

    var test_paths = {
      {% for app, opts in app_suites.apps.items %}
        '{{ app }}': [
          {% for suite_path in opts.suite.get_suite_paths %}
           '{{ app }}/{{ suite_path }}'{% if not forloop.last %},{% endif %}
          {% endfor %}
          ]{% if not forloop.last %},{% endif %}
      {% endfor %}
    }

    function updateApp(app, result) {
      app.find("a").removeClass();
      if (typeof result === "undefined") {
        result = {
          'last_run': 'N/A',
          'runtime': 'N/A',
          'passed': 'N/A',
          'failed': 'N/A',
          'total': 'N/A'
        }
        app.find("strong").html("N/A");
      } else if (result.failed === 0) {
        app.find("a").addClass("passed");
        app.find("strong").html("PASSED");
      } else {
        app.find("a").addClass("failed");
        app.find("strong").html("FAILED");
      }
      app.find("small:nth-child(2)").html("last ran: " + result.last_run);
      app.find("small:nth-child(3)").html("Duration (ms) " + result.runtime);
      app.find("small:nth-child(4)").html("passed: " + result.passed);
      app.find("small:nth-child(5)").html("failed: " + result.failed);
      app.find("small:nth-child(6)").html("total: " + result.total);
    }

    var updateStatus = function(app, suite_path, result) {
      results[app][suite_path] = result;
      if (get_keys(results[app]).length === test_paths[app].length) {
        var date = new Date();
        var app_result;
        var failed = passed = total = runtime = 0;

        for(path in results[app]) {
          result = results[app][path];
          passed += result.passed;
          failed += result.failed;
          total += result.total;
          runtime += result.runtime;
        }

        app_result = {
          'passed': passed,
          'failed': failed,
          'total': total,
          'runtime': runtime,
          'last_run': date.toDateString()
        };
        updateApp($("#"+app), app_result);
        store.set(suite_hashes[app], app_result);
      }
    }

    $(document).ready(function() {
      var last_result;
      var apps = $(".app");
      apps.find("p > a").removeClass();
      for (var i = 0; i < apps.length; i++) {
        last_result = store.get(suite_hashes[apps[i].id]);
        updateApp($(apps[i]), last_result);
      }
      $('.app p button').click(function() {
        var path;
        var app = $(this).parent().parent()[0].id;
        var iframes = [];
        // Reset from previous runs
        initializeResults();
        $('iframe').remove();
        for (var i = 0; i < test_paths[app].length; i++) {
          path = test_paths[app][i];
          iframes[i] = $('<iframe name="' + app + '" src="/' + path + '" class="hidden"></iframe>');
          $("body").append(iframes[i]);
        }
      });
    });

    function reset() {
      store.clear();
      for(app in test_paths) {
        updateApp($("#"+app));
      }
    }
  </script>
</head>

<body>
  <h1 id="qunit-header">{% block header %}QUnit Test Suite {% block title %}{% endblock title %}{% endblock %}</h1>
  <h2 id="qunit-banner">{% block banner %}{% endblock banner %}</h2>
  <div id="qunit-testrunner-toolbar">{% block toolbar %}{% endblock toolbar %}</div>
  {% block content %}
    {% if app_suites %}
    <div class="apps">
      {% for label, options in app_suites.apps.items %}
      <div class="app" id="{{ label }}">
        <h3><a href="{{ label }}/">{{ options.name }}</a></h3>
        <p>
          <a title="">
            <strong>N/A</strong>
            <small>last ran: N/A </small>
            <small>Duration (ms): N/A</small>
            <small>passed: N/A</small>
            <small>failed: N/A</small>
            <small>total: N/A</small>
          </a>
        </p>
        <p>
          <button>Run Tests</button>
        </p>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  {% endblock content %}
</body>
</html>
